<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Love Fireworks</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script>
      let fireworks = [];
      let t;
      let x = [],
        y = [];
      let textAlpha = 0,
        showText = false,
        frames = 0;

      function setup() {
        createCanvas(windowWidth, windowHeight);
        t = Array.from({ length: 100 }, (_, i) => (i * TWO_PI) / 100);
        x = t.map((t) => 16 * pow(sin(t), 3) * 30);
        y = t.map(
          (t) =>
            (13 * cos(t) - 5 * cos(2 * t) - 2 * cos(3 * t) - cos(4 * t)) * 30
        );
      }

      function draw() {
        background(0);

        if (random(1) < 0.05) {
          fireworks.push(new Firework());
          showText = true;
          textAlpha = 0; // 重新開始淡入效果
          frames = 0;
        }

        for (let i = fireworks.length - 1; i >= 0; i--) {
          fireworks[i].update();
          fireworks[i].show();
          if (fireworks[i].done()) {
            fireworks.splice(i, 1);
          }
        }

        if (showText) {
          textAlpha = min(255, textAlpha + 5);
          frames++;
          if (frames > 300) {
            // 文字顯示更久
            showText = false;
          }

          fill(255, 0, 0, textAlpha);
          textSize(100);
          textAlign(CENTER, CENTER);
          text("I love you", width / 2, height / 2);
        }
      }

      class Firework {
        constructor() {
          this.color = color(
            random(200, 255),
            random(50, 255),
            random(50, 255)
          );
          this.pos = createVector(random(200, width - 200), height);
          this.vel = createVector(0, random(-15, -8));
          this.exploded = false;
          this.particles = [];
        }

        update() {
          if (!this.exploded) {
            this.pos.add(this.vel);
            this.vel.y += 0.2;
            if (this.vel.y >= 0) {
              this.exploded = true;
              this.explode();
            }
          } else {
            for (let i = this.particles.length - 1; i >= 0; i--) {
              this.particles[i].update();
              if (this.particles[i].done()) {
                this.particles.splice(i, 1);
              }
            }
          }
        }

        explode() {
          for (let i = 0; i < x.length; i++) {
            let px = this.pos.x + x[i];
            let py = this.pos.y - y[i];
            this.particles.push(new Particle(px, py, this.color));
          }
        }

        show() {
          if (!this.exploded) {
            fill(this.color);
            ellipse(this.pos.x, this.pos.y, 8, 8);
          } else {
            for (let p of this.particles) {
              p.show();
            }
          }
        }

        done() {
          return this.exploded && this.particles.length === 0;
        }
      }

      class Particle {
        constructor(x, y, c) {
          this.pos = createVector(x, y);
          this.vel = createVector(random(-3, 3), random(-3, 3));
          this.lifetime = random(30, 60);
          this.size = random(2, 5);
          this.color = c;
        }

        update() {
          this.pos.add(this.vel);
          this.vel.y += 0.05;
          this.lifetime--;
          this.size = max(this.size - 0.1, 1);
        }

        show() {
          if (this.lifetime > 0) {
            fill(this.color);
            noStroke();
            ellipse(this.pos.x, this.pos.y, this.size);
          }
        }

        done() {
          return this.lifetime <= 0;
        }
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
      }
    </script>
  </head>
  <body style="margin: 0; overflow: hidden"></body>
</html>
